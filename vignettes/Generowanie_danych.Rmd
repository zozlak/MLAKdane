---
title: "Generowanie danych"
author: "Mateusz Żółtak"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=FALSE)
```

# Przygotowanie danych

## Przygotowujemy dane zus, statystyki z BNL przypisane do PNA, dane OPI (zbiór ZDAU), itp.

```{r}
library(dplyr)
dataMin = '2014-01-01'
dataMax = '2015-03-31' # 2015-03-31 dla starych danych

pnaPowiaty = polacz_pna_powiaty(przygotuj_pna(), przygotuj_powiaty(), dataMin, dataMax) # t1
jednostki = przygotuj_jednostki() # t2
zdau = przygotuj_zdau() # t5
zus = przygotuj_zus(dataMin, dataMax) # t3
# save(zus, file = 'cache/ZUS.RData', compress = TRUE)
# load('cache/ZUS.RData')
```

## Wyliczamy pomocniczy zbiór etat etatu i złączamy dane ZUS z danymi OPI

```{r}
utrataEtatu = przygotuj_utrata_pracy(zus, dataMax) # t4
# save(utrataEtatu, file = 'cache/utrataEtatu.RData', compress = TRUE)
# load('cache/utrataEtatu.RData')
baza = polacz_zus_zdau(zus, zdau, pnaPowiaty, dataMin, dataMax) # t6
```

# Wyliczamy zmienne

## Zmienne zależące od okienka czasu

```{r}
okienkaMin = c(1, 1)
okienkaMax = c(12, 1000)
okienkaSufiksy = c('_p1', '')
for(i in seq_along(okienkaMin)){
  okienkoMin = okienkaMin[i]
  okienkoMax = okienkaMax[i]
  cat(okienkoMin, '-', okienkoMax)

  okienko = oblicz_okienko(baza, okienkoMin, okienkoMax, dataMin, dataMax) # t9

  abs1 = oblicz_absolwent(okienko) # t10
  abs2 = oblicz_absolwent_okres(okienko) # t11
  nnn  = oblicz_nowi_pracodawcy(okienko) # t12
  nmle = oblicz_utrata_etatu(okienko, utrataEtatu) # t13
  zam  = oblicz_zamieszkanie(okienko, jednostki, okienkoMax == 1000) # t14
  razem = oblicz_okienko(zdau, okienkoMin, okienkoMax, dataMin, dataMax) %>%  # t15
    select(id_zdau, len) %>%
    right_join(abs1) %>%
    full_join(abs2) %>%
    full_join(nnn) %>%
    full_join(nmle) %>%
    full_join(zam)
  rm(abs1, abs2, nnn, nmle, zam)
  gc()
  razem = oblicz_zmienne_pochodne(razem) # t16
  
  colnames(razem) = sub('^id_zdau.*$', 'id_zdau', paste0(colnames(razem), okienkaSufiksy[i]))
  save(razem, file = paste0('cache/razem', i, '.RData'), compress = TRUE)
  rm(razem)
  gc()
}
```

## Zmienne z grupy STUDYP oraz CZAS*

Zmienne KONT, STUDYP* oraz CZAS* są niezależne od okienka czasu, wyliczamy je więc oddzielnie:
```{r}
studyp = oblicz_studyp(zdau) # t7
czas = oblicz_zmienne_czasowe(baza, utrataEtatu) # t8
```

# Złączamy wszystko razem i zapisujemy

```{r}
wszystko = zdau %>%
  filter_(~ typ %in% 'A') %>%
  full_join(studyp) %>%
  full_join(czas) %>%
  left_join(przygotuj_kierunki()) %>%
  left_join(jednostki %>% select(jednostka_id, jednostka, uczelnia))
for(i in seq_along(okienkaMin)){
  load(paste0('cache/razem', i, '.RData'))
  wszystko = full_join(wszystko, razem)
}
stopifnot(
  nrow(wszystko) == nrow(zdau %>% filter_(~ typ %in% 'A'))
)
colnames(wszystko) = toupper(colnames(wszystko))
save(wszystko, file = 'cache/złączone.RData', compress = TRUE)
write.csv2(wszystko, 'cache/złączone.csv', row.names = FALSE, fileEncoding = 'Windows-1250')
```

